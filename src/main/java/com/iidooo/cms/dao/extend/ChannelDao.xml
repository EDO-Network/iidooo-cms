<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="com.iidooo.cms.dao.extend.ChannelDao">
	<resultMap id="BaseResultMap" type="com.iidooo.cms.dto.extend.ChannelDto">
		<id column="ChannelID" property="channelID" jdbcType="INTEGER" />
		<result column="ParentID" property="parentID" jdbcType="INTEGER" />
		<result column="SiteID" property="siteID" jdbcType="INTEGER" />
		<result column="ChannelName" property="channelName" jdbcType="VARCHAR" />
		<result column="ChannelPath" property="channelPath" jdbcType="VARCHAR" />
		<result column="ChannelLevel" property="channelLevel" jdbcType="INTEGER" />
		<result column="MetaTitle" property="metaTitle" jdbcType="VARCHAR" />
		<result column="MetaKeywords" property="metaKeywords" jdbcType="VARCHAR" />
		<result column="MetaDescription" property="metaDescription" jdbcType="VARCHAR" />
		<result column="Sequence" property="sequence" jdbcType="INTEGER" />
		<result column="IsHidden" property="isHidden" jdbcType="INTEGER" />
		<result column="Remarks" property="remarks" jdbcType="VARCHAR" />
		<result column="CreateTime" property="createTime" jdbcType="VARCHAR" />
		<result column="CreateUser" property="createUser" jdbcType="INTEGER" />
		<result column="UpdateTime" property="updateTime" jdbcType="VARCHAR" />
		<result column="UpdateUser" property="updateUser" jdbcType="INTEGER" />
		<result column="IsDelete" property="isDelete" jdbcType="INTEGER" />
		<result column="Version" property="version" jdbcType="INTEGER" />
	</resultMap>
	<sql id="Base_Column_List">
		C.ChannelID, C.ParentID, C.SiteID, C.ChannelName, C.ChannelPath, C.ChannelLevel, C.MetaTitle,
		C.MetaKeywords,
		C.MetaDescription,C.Sequence,C.IsHidden, C.Remarks, C.CreateTime,
		C.CreateUser, C.UpdateTime, C.UpdateUser, C.IsDelete, C.Version
	</sql>
	
	<select id="selectCountBySiteID" resultType="java.lang.Integer" parameterType="java.lang.Integer">
		select count(C.ChannelID)
		from CMS_CHANNEL C where C.IsDelete = 0 and C.SiteID = #{siteID,jdbcType=INTEGER}
	</select>

	<select id="selectBySiteCode" resultMap="BaseResultMap">
		select
		<include refid="Base_Column_List" />
		, S.SiteURL as siteURL
		from CMS_CHANNEL C
		join CMS_SITE S
		on C.SiteID = S.SiteID and C.IsDelete = 0 and S.IsDelete = 0
		and S.SiteCode =
		#{siteCode,jdbcType=VARCHAR}
	</select>

	<select id="selectChannelChildren" resultMap="BaseResultMap">
		select
		<include refid="Base_Column_List" />
		, S.SiteURL as siteURL
		from CMS_CHANNEL C
		join CMS_SITE S
		on C.SiteID = S.SiteID and C.IsDelete = 0 and S.IsDelete = 0
		and S.SiteCode =
		#{siteCode,jdbcType=VARCHAR}
		<if test="parentPath != null">
			join CMS_CHANNEL P
			on C.ParentID = P.ChannelID and
			P.ChannelPath = #{parentPath,jdbcType=VARCHAR}
		</if>
		<if test="parentPath == null">
			and C.ParentID = 0
		</if>
	</select>

	<select id="selectChannelByPath" resultMap="BaseResultMap">
		select
		<include refid="Base_Column_List" />
		from CMS_CHANNEL C
		join CMS_SITE S
		on C.IsDelete = 0 and S.IsDelete = 0 and C.SiteID = S.SiteID
		and S.SiteCode = #{siteCode,jdbcType=VARCHAR} and
		C.ChannelPath =
		#{channelPath,jdbcType=VARCHAR}
	</select>

	<select id="selectByChannelID" resultMap="BaseResultMap" parameterType="java.lang.Integer">
		select
		<include refid="Base_Column_List" />
		from CMS_CHANNEL C
		where C.IsDelete = 0 and
		C.ChannelID = #{channelID,jdbcType=INTEGER}
	</select>

	<select id="selectChannelListCount" resultType="java.lang.Integer" parameterType="com.iidooo.cms.dto.extend.ChannelDto">
		select count(*)
		from CMS_CHANNEL C where C.IsDelete = 0
		<if test="parentID != null">
			and C.ParentID = #{parentID,jdbcType=INTEGER}
		</if>
		<if test="siteID != null">
			and C.SiteID = #{siteID,jdbcType=INTEGER}
		</if>
		<if test="channelPath != null">
			and C.ChannelPath = #{channelPath,jdbcType=VARCHAR}
		</if>
	</select>

	<select id="selectChannelList" resultMap="BaseResultMap" parameterType="com.iidooo.cms.dto.extend.ChannelDto">
		select
		<include refid="Base_Column_List" />
		from CMS_CHANNEL C where C.IsDelete = 0
		<if test="parentID != null">
			and C.ParentID = #{parentID,jdbcType=INTEGER}
		</if>
		<if test="siteID != null">
			and C.SiteID = #{siteID,jdbcType=INTEGER}
		</if>
		<if test="channelPath != null">
			and C.ChannelPath = #{channelPath,jdbcType=VARCHAR}
		</if>
		order by C.Sequence
	</select>

	<select id="selectMaxSequence" resultType="java.lang.Integer" parameterType="java.lang.Integer">
		select max(C.Sequence)
		from CMS_CHANNEL C
		where C.IsDelete = 0
		and
		C.ParentID = #{parentID,jdbcType=INTEGER}
	</select>

	<insert id="insert" useGeneratedKeys="true" keyProperty="channelID" parameterType="com.iidooo.cms.dto.extend.ChannelDto">
		insert into CMS_CHANNEL (
		ParentID,
		SiteID,
		ChannelName,
		ChannelPath,
		ChannelLevel,
		MetaTitle,
		MetaKeywords,
		MetaDescription,
		Sequence,
		IsHidden, Remarks, CreateTime,
		CreateUser, UpdateTime,
		UpdateUser, IsDelete,
		Version
		)
		values
		(#{parentID,jdbcType=INTEGER},
		#{siteID,jdbcType=INTEGER},
		#{channelName,jdbcType=VARCHAR},
		#{channelPath,jdbcType=VARCHAR},
		#{channelLevel,jdbcType=INTEGER},#{metaTitle,jdbcType=VARCHAR},
		#{metaKeywords,jdbcType=VARCHAR},
		#{metaDescription,jdbcType=VARCHAR},
		#{sequence,jdbcType=INTEGER}, #{isHidden,jdbcType=INTEGER},
		#{remarks,jdbcType=VARCHAR},
		#{createTime,jdbcType=VARCHAR},
		#{createUser,jdbcType=INTEGER},
		#{updateTime,jdbcType=VARCHAR},
		#{updateUser,jdbcType=INTEGER}, 0, 1)
	</insert>

	<update id="update" parameterType="com.iidooo.cms.dto.extend.ChannelDto">
		update CMS_CHANNEL
		set ParentID = #{parentID,jdbcType=INTEGER},
		ChannelName =
		#{channelName,jdbcType=VARCHAR},
		ChannelPath = #{channelPath,jdbcType=VARCHAR},
		ChannelLevel =
		#{channelLevel,jdbcType=INTEGER},
		MetaTitle =
		#{metaTitle,jdbcType=VARCHAR},
		MetaKeywords =
		#{metaKeywords,jdbcType=VARCHAR},
		MetaDescription =
		#{metaDescription,jdbcType=VARCHAR},
		Sequence =
		#{sequence,jdbcType=INTEGER},
		IsHidden =
		#{isHidden,jdbcType=INTEGER},
		Remarks =
		#{remarks,jdbcType=VARCHAR},
		UpdateTime = #{updateTime,jdbcType=VARCHAR},
		UpdateUser =
		#{updateUser,jdbcType=INTEGER},
		Version = Version + 1
		where
		ChannelID = #{channelID,jdbcType=INTEGER}
	</update>

	<update id="deleteByChannelID" parameterType="com.iidooo.cms.dto.extend.ChannelDto">
		update CMS_CHANNEL
		set IsDelete = 1,
		UpdateTime = #{updateTime,jdbcType=VARCHAR},
		UpdateUser =
		#{updateUser,jdbcType=INTEGER},
		Version = Version + 1
		where ChannelID = #{channelID,jdbcType=INTEGER}
	</update>
</mapper>